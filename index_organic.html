<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMap - Organic Theme</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Fonts: Nunito for Organic Feel -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="style_organic.css">
</head>

<body>

    <div id="toast-container"></div>

    <div id="login-screen" class="hidden">
        <div class="login-box">
            <h2 class="panel-title">Advisor Login</h2>
            <div class="form-group">
                <label for="login-user">Username</label>
                <input type="text" id="login-user" name="username" autocomplete="username" class="form-control"
                    placeholder="username">
            </div>
            <div class="form-group">
                <label for="login-pass">Password</label>
                <input type="password" id="login-pass" name="password" autocomplete="current-password"
                    class="form-control" placeholder="password">
            </div>
            <p id="login-error" style="color: red; font-size: 0.9rem; margin-bottom: 15px;" class="hidden">Invalid
                credentials</p>
            <button class="btn-save" onclick="login()">Enter Garden</button>
            <button class="btn-save" style="background: #ccc; color: #444;"
                onclick="document.getElementById('login-screen').classList.add('hidden')">Cancel</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container">

        <!-- Organic Top Bar -->
        <div id="top-bar">
            <div class="brand-section">
                <i class="fa-solid fa-seedling"></i>
                <span>EcoMap</span>
            </div>

            <div class="top-center-island">
                <div class="search-section">
                    <input type="text" id="search-input" name="search" autocomplete="off"
                        placeholder="Find green spots...">
                    <button class="search-btn" onclick="searchLocation()">
                        <i class="fa-solid fa-leaf"></i>
                    </button>
                    <div id="search-suggestions" class="search-suggestions hidden"></div>
                </div>

                <div class="filters-section">
                    <button id="filter-all" class="capsule-btn hidden" onclick="filterMarkers('all')">All</button>
                    <button class="capsule-btn" onclick="filterMarkers('Garbage Containers')">Bins</button>
                    <button class="capsule-btn" onclick="filterMarkers('Dumping Yard')">Yards</button>
                    <button class="capsule-btn" onclick="filterMarkers('Korgans')">Korgans</button>
                </div>
            </div>
        </div>



        <!-- Organic Sidebar -->
        <div id="sidebar">
            <div class="user-badge" id="user-badge">GUEST</div>



            <div class="sidebar-item" id="mark-btn" onclick="toggleMarkMode()" title="Add Marker">
                <i class="fa-solid fa-plus"></i>
            </div>

            <div class="sidebar-item layer-container" title="Layers">
                <i class="fa-solid fa-layer-group"></i>
                <div class="layer-dropdown">
                    <div class="layer-option" onclick="switchLayer('street')">Street</div>
                    <div class="layer-option" onclick="switchLayer('satellite')">Satellite</div>
                    <div class="layer-option" onclick="switchLayer('heatmap')">Heatmap</div>
                </div>
            </div>
            <div class="sidebar-item" onclick="locateUser()" title="My Location">
                <i class="fa-solid fa-location-arrow"></i>
            </div>

            <div class="zoom-controls">
                <button onclick="map.zoomIn()"><i class="fa-solid fa-plus"></i></button>
                <div class="zoom-divider"></div>
                <button onclick="map.zoomOut()"><i class="fa-solid fa-minus"></i></button>
            </div>

            <div class="spacer"></div>

            <div class="sidebar-item" id="auth-btn" onclick="handleAuthClick()">
                <i id="auth-icon" class="fa-solid fa-user-circle"></i>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Info Panel -->
        <div id="info-panel" class="hidden">
            <button class="panel-close-btn" onclick="closePanel()">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div id="panel-content">
                <!-- Dynamic Content -->
            </div>
        </div>

    </div>

    <!-- Find Nearest FAB -->
    <div id="find-nearest-btn" onclick="findNearest()" title="Find Nearest Bin">
        <i class="fa-solid fa-compass"></i>
    </div>

    <!-- Chatbot -->
    <div id="chatbot-icon" onclick="toggleChat()">
        <i class="fa-solid fa-comment-dots"></i>
    </div>

    <div id="chatbot-box" class="hidden">
        <div class="chat-header">
            EcoGuide
            <i class="fa-solid fa-xmark" style="float: right; cursor: pointer;" onclick="toggleChat()"></i>
        </div>
        <div id="chat-messages">
            <div class="message bot-msg">Hello! How can we make Lahore greener?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" name="chat" class="form-control" placeholder="Ask nature..."
                onkeypress="handleChatKey(event)">
            <button class="btn-save" style="width: auto; margin:0;" onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
            <button id="voice-mic" class="btn-save" style="width: auto; margin:0; background: #FFB300;"
                onclick="initVoiceCommand()" title="Voice Command">
                <i class="fa-solid fa-microphone"></i>
            </button>
        </div>
    </div>

    <!-- Call UI -->
    <!-- 1. Guest/User Call Button -->
    <div id="call-support-button" class="hidden" onclick="initiateCall()" title="Call Support">
        <i class="fa-solid fa-headset"></i>
    </div>

    <!-- 2. Active Call Modal (For both) -->
    <div id="call-modal" class="hidden">
        <div class="call-box">
            <div class="call-avatar">
                <i class="fa-solid fa-user"></i>
            </div>
            <div class="call-avatar">
                <i class="fa-solid fa-user"></i>
            </div>
            <h3 id="call-status-text">Calling Support...</h3>
            <div id="call-timer" class="hidden">00:00</div>
            <audio id="remote-audio" autoplay hidden></audio>

            <div class="call-actions">
                <button class="call-btn btn-hangup" onclick="endCall()">
                    <i class="fa-solid fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 3. Incoming Call Modal (For Admin) -->
    <div id="incoming-call-modal" class="hidden">
        <div class="call-box incoming">
            <div class="call-avatar animate-pulse">
                <i class="fa-solid fa-phone"></i>
            </div>
            <h3>Incoming Call</h3>
            <p id="incoming-caller-name">Guest</p>

            <div class="call-actions">
                <button class="call-btn btn-accept" onclick="answerCall()">
                    <i class="fa-solid fa-phone"></i>
                </button>
                <button class="call-btn btn-hangup" onclick="rejectCall()">
                    <i class="fa-solid fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="hidden">
        <div class="report-box" style="position: relative;">
            <button onclick="closeReportModal()"
                style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            <h2 class="panel-title">Report Issue</h2>
            <div class="form-group">
                <label for="report-location">Location</label>
                <input type="text" id="report-location" name="location" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="report-type">Issue Type</label>
                <select id="report-type" name="issue-type" class="form-control">
                    <option value="full">Container is Full</option>
                    <option value="damaged">Container is Damaged</option>
                    <option value="missing">Container is Missing</option>
                    <option value="illegal-dump">Illegal Dumping Spotted</option>
                    <option value="other">Other Issue</option>
                </select>
            </div>
            <div class="form-group">
                <label for="report-description">Description</label>
                <textarea id="report-description" name="description" class="form-control" rows="4"></textarea>
            </div>
            <button class="btn-save" onclick="submitReport()">Submit Report</button>
        </div>
    </div>

    <!-- Edit Marker Modal -->
    <div id="edit-modal" class="hidden">
        <div class="report-box" style="position: relative;">
            <button onclick="closeEditModal()"
                style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            <h2 class="panel-title">Edit Marker</h2>
            <input type="hidden" id="edit-marker-id">
            <div class="form-group">
                <label for="edit-title">Title</label>
                <input type="text" id="edit-title" class="form-control">
            </div>
            <div class="form-group">
                <label for="edit-type">Type</label>
                <select id="edit-type" class="form-control">
                    <option value="Garbage Container">Garbage Container</option>
                    <option value="Recycle Bin">Recycle Bin</option>
                    <option value="Dumping Yard">Dumping Yard</option>
                    <option value="Korgans">Korgans</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-address">Address</label>
                <input type="text" id="edit-address" class="form-control">
            </div>
            <div class="form-group">
                <label for="edit-notes">Notes</label>
                <textarea id="edit-notes" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="edit-status">Status</label>
                <select id="edit-status" class="form-control">
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="maintenance">Maintenance</option>
                </select>
            </div>
            <button class="btn-save" onclick="submitEdit()">Save Changes</button>
        </div>
    </div>

    <!-- Agent/Admin Dashboard Modal -->
    <div id="dashboard-modal" class="hidden">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <div>
                    <h2 style="margin:0;">EcoMap Dashboard</h2>
                    <p style="margin:5px 0 0; opacity:0.8; font-size:0.9rem;">Manage contributions and track progress
                    </p>
                </div>
                <button onclick="closeDashboard()" class="close-dashboard-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="dashboard-content">
                <!-- 1. Profile Card -->
                <div class="dashboard-card profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fa-solid fa-user-astronaut"></i>
                        </div>
                        <div class="profile-info">
                            <h3 id="dash-username">User</h3>
                            <div class="role-badge" id="dash-role">Agent</div>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="dash-points">0</div>
                            <div class="stat-label">Points</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="dash-level">1</div>
                            <div class="stat-label">Level</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="dash-contrib">0</div>
                            <div class="stat-label">Reports</div>
                        </div>
                    </div>
                </div>

                <!-- 2. Notifications -->
                <div class="dashboard-card notification-card">
                    <h3><i class="fa-solid fa-bell"></i> Notifications</h3>
                    <div id="dash-notifications-list" class="notification-list">
                        <!-- Items injected by JS -->
                        <div class="empty-state">No new notifications</div>
                    </div>
                </div>

                <!-- 3. Leaderboard -->
                <div class="dashboard-card leaderboard-card">
                    <h3><i class="fa-solid fa-trophy"></i> Top Contributors</h3>
                    <div id="dash-leaderboard-list" class="leaderboard-list">
                        <!-- Items injected by JS -->
                        <div class="leaderboard-item">
                            <span class="rank">1</span>
                            <span class="name">Sarah Green</span>
                            <span class="score">1,250 pts</span>
                        </div>
                        <div class="leaderboard-item">
                            <span class="rank">2</span>
                            <span class="name">Mike Eco</span>
                            <span class="score">980 pts</span>
                        </div>
                        <div class="leaderboard-item">
                            <span class="rank">3</span>
                            <span class="name">LahoreCleanup</span>
                            <span class="score">850 pts</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Footer -->
            <div
                style="margin-top: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                <button onclick="logout(); closeDashboard();" class="btn-save"
                    style="background: rgba(255, 82, 82, 0.2); color: #ff5252; border: 1px solid #ff5252; width: auto; padding: 8px 24px;">
                    <i class="fa-solid fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px);">
        <div style="text-align:center;">
            <div class="spinner"
                style="width:60px; height:60px; border:6px solid #f3f3f3; border-top:6px solid #2E7D32; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px;">
            </div>
            <div style="font-size:1.2rem; color:#2E7D32; font-weight:600;" id="loading-text">Loading...</div>
        </div>
    </div>
    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- Script Imports (Same as Main) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="/socket.io/socket.io.js"></script> <!-- Socket.io Client -->
    <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script> <!-- SimplePeer -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script> <!-- Heatmap Lib -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <!-- Clustering Lib -->
    <script src="containers.js"></script>
    <script src="markers.js"></script>
    <script src="lahore_boundary.js"></script>
    <script src="lahore_data_v2.js"></script>
    <script src="korgans.js"></script>
    <script src="chatbot_database.js"></script>
    <script src="script.js"></script>
</body>

</html>